drop schema if exists validasi;
create schema validasi authorization postgres;

create or replace function validasi.tipejenisinfo(infojenis character varying, infolabel character varying)
  returns character varying as
$body$
declare 
    inforeturn character varying;
begin
	if infojenis = 'jenis' then
		if coalesce(nullif(infolabel, ''), null) is null then
			inforeturn:= 'Tambah Data';
		elsif infolabel = 'xxx' then
			inforeturn:= 'Hapus';
		else
			inforeturn:= 'Ubah Data';
		end if;
	elsif infojenis = 'status' then
		if coalesce(nullif(infolabel, ''), null) is null then
			inforeturn:= 'Belum Validasi';
		elsif infolabel = '1' then
			inforeturn:= 'Validasi';
		else
			inforeturn:= 'Ditolak';
		end if;
	elsif infojenis = 'hak' then
		if infolabel = '1' then
			inforeturn:= 'Sesuai Unit Kerja';
		elsif infolabel = '20' then
			inforeturn:= 'Unit Kerja / Induk Unit Kerja';
		elsif infolabel = '30' then
			inforeturn:= 'BKDPP';
		else
			inforeturn:= 'Belum ditentukan';
		end if;
	elsif infojenis = 'riwayat' then
		inforeturn:= infolabel;
		--select nama into inforeturn from validasi.riwayat_update where riwayat_update_id = infolabel::numeric;
	end if;

	return inforeturn;
end;

$body$
language plpgsql volatile cost 100;
alter function validasi.tipejenisinfo(character varying, character varying) owner to postgres;

create or replace function validasi.vupdateinfo(vtable character varying, vinfoid numeric, vinforowid numeric, vlastuser character varying, vlastlevel numeric)
  returns character varying as
$body$
declare 
	thequery character varying;
	inforeturn character varying;
	pjsonperubahan json;
	recperubahandata record;
	vseparator character varying;
	vupdateheader character varying;
	vupdateheaderdetil character varying;
begin
	inforeturn:= '';
	vupdateheaderdetil:= '';
	
	if vinfoid is not null and vinforowid is not null then
		vseparator:= '';
		vupdateheader:= 'update '||vtable||' set ';
		vupdateheaderdetil:= '';
					
		thequery:= '
		select regexp_replace(perubahan_data, e''[\\n\\r\\u2028]+'', '' '', ''g'' )
		from validasi.'|| vtable ||' where temp_validasi_id = ' || vinforowid;
		execute thequery into pjsonperubahan using vtable, vinforowid;
	end if;

	for recperubahandata in select key from json_each(pjsonperubahan) where not key = '0' 
	loop
		if coalesce(nullif(vupdateheaderdetil, ''), null) is not null then
			vseparator:= ', ';
		end if;

		vupdateheaderdetil:= vupdateheaderdetil || vseparator || recperubahandata.key || ' = ' || '(select ' || recperubahandata.key || ' from validasi.'|| vtable ||' where temp_validasi_id = ' || vinforowid || ')';
		
	end loop;

	if coalesce(nullif(vupdateheaderdetil, ''), null) is not null then
		/*
		if lower(vtable) = 'sk_cpns' then
			vupdateheaderdetil:= vupdateheaderdetil || ', triger_pangkat = null';
		end if;
		*/
		
		--vupdateheaderdetil:= vupdateheaderdetil || ', last_user = ''' || vlastuser || ''' , last_level = ''' || vlastlevel || ''', last_date = now()';
		if coalesce(nullif(vlastuser, ''), null) is null then
			vlastuser:= '';
		end if;
		vupdateheaderdetil:= vupdateheaderdetil || ', last_update_user = ''' || vlastuser || ''' , last_update_date = now()';
		inforeturn:= vupdateheader || vupdateheaderdetil || ' where '|| vtable ||'_id = ' || vinfoid;
	end if;

	return inforeturn;
end;

$body$
language plpgsql volatile cost 100;
alter function validasi.vupdateinfo(character varying, numeric, numeric, character varying, numeric) owner to postgres;

create or replace function validasi.collectinfo(infoperubahan character varying, infolabel character varying, dataperubahan character varying, datamaster character varying)
  returns character varying as
$body$
declare 
    infochek character varying;
begin
	if not coalesce(dataperubahan, '') = coalesce(datamaster, '') then
		if lower(datamaster) = 'valsixdatabaru' then
			infoperubahan := infoperubahan || ', "' || infolabel || '" : ["' || coalesce(dataperubahan, '') || '", "' || infolabel || '"]'; 
		else
			infoperubahan := infoperubahan || ', "' || infolabel || '" : ["' || coalesce(datamaster, '') || '", "' || infolabel || '"]'; 
		end if;
	end if;

	return infoperubahan;
end;

$body$
language plpgsql volatile cost 100;
alter function validasi.collectinfo(character varying, character varying, character varying, character varying) owner to postgres;

create or replace function validasi.tipejenisinfo(infojenis character varying, infolabel character varying)
  returns character varying as
$body$
declare 
    inforeturn character varying;
begin
	if infojenis = 'jenis' then
		if coalesce(nullif(infolabel, ''), null) is null then
			inforeturn:= 'Baru';
		elsif infolabel = 'xxx' then
			inforeturn:= 'Hapus';
		else
			inforeturn:= 'Update';
		end if;
	elsif infojenis = 'status' then
		if coalesce(nullif(infolabel, ''), null) is null then
			inforeturn:= 'Proses';
		elsif infolabel = '1' then
			inforeturn:= 'Terklarifikasi';
		else
			inforeturn:= 'Ditolak';
		end if;
	elsif infojenis = 'hak' then
		if infolabel = '1' then
			inforeturn:= 'Sesuai Unit Kerja';
		elsif infolabel = '20' then
			inforeturn:= 'Unit Kerja / Induk Unit Kerja';
		elsif infolabel = '30' then
			inforeturn:= 'BKDPP';
		else
			inforeturn:= 'Belum ditentukan';
		end if;
	elsif infojenis = 'riwayat' then
		select nama into inforeturn from validasi.riwayat_update where riwayat_update_id = infolabel::numeric;
	end if;

	return inforeturn;
end;

$body$
language plpgsql volatile cost 100;
alter function validasi.tipejenisinfo(character varying, character varying) owner to postgres;

drop table if exists validasi.hapus_data;
create table validasi.hapus_data
(
	hapus_data_id integer
	, pegawai_id numeric not null
	, temp_validasi_id integer not null
	, hapus_nama character varying
	, last_create_user character varying
	, last_create_date timestamp without time zone
	, last_user character varying
	, last_date timestamp without time zone
	, validasi integer
	, tanggal_validasi timestamp without time zone
);

drop table if exists validasi.hapus_log;
create table validasi.hapus_log
(
	temp_validasi_id integer
	, row_id numeric
	, row_hapus_id numeric
	, info_link character varying
	, info_table character varying
	, pegawai_id numeric
	, info_riwayat character varying
	, info_jenis character varying
	, info_keterangan character varying
	, info_tanggal date
	, info_jenis_update character varying
	, info_status character varying
	, info_level numeric
	, info_level_nama character varying
	, info_validasi numeric
	, info_create_date timestamp without time zone
	, perubahan_data character varying
);

create or replace function validasi.validasi_hapus_data_hapus()
  returns trigger as
$body$
declare
    thequery character varying;
    begin
	insert into validasi.hapus_log
	(
		temp_validasi_id, row_id, row_hapus_id, info_link, info_table, pegawai_id
		, info_riwayat, info_jenis, info_keterangan
		, info_tanggal, info_jenis_update, info_status, info_level, info_level_nama
		, info_validasi
		, info_create_date, perubahan_data
	)
	select 	
	temp_validasi_id, row_id, row_hapus_id, info_link, info_table, pegawai_id
	, info_riwayat, info_jenis, info_keterangan
	, info_tanggal, info_jenis_update, 'batal' info_status, info_level, info_level_nama
	, -1 info_validasi
	, now() info_create_date, ''
	from validasi.validasi_perubahandatavalidasi(old.pegawai_id::text) a
	where 1 = 1 and row_hapus_id = old.temp_validasi_id and info_table = lower(old.hapus_nama);

	return old;
    end;
$body$
language plpgsql volatile cost 100;
alter function validasi.validasi_hapus_data_hapus() owner to postgres;
  
drop trigger if exists validasi_hapus_data_trigger_hapus on validasi.hapus_data;
create trigger validasi_hapus_data_trigger_hapus
before delete
on validasi.hapus_data
for each row
execute procedure validasi.validasi_hapus_data_hapus();

create or replace function validasi.validasi_hapus_data_update()
returns trigger as
$body$
declare
thequery character varying;
begin
	if new.validasi = 1 then
		insert into validasi.hapus_log
		(
			temp_validasi_id, row_id, row_hapus_id, info_link, info_table, pegawai_id
			, info_riwayat, info_jenis, info_keterangan
			, info_tanggal, info_jenis_update, info_status, info_level, info_level_nama
			, info_validasi
			, info_create_date, perubahan_data
		)
		select 	
		temp_validasi_id, row_id, row_hapus_id, info_link, info_table, pegawai_id
		, info_riwayat, info_jenis, info_keterangan
		, info_tanggal, info_jenis_update, 'Hapus' info_status, info_level, info_level_nama
		, -1 info_validasi
		, now() info_create_date, ''
		from validasi.validasi_perubahandatavalidasi(new.pegawai_id::text) a
		where 1 = 1 and row_hapus_id = new.temp_validasi_id and info_table = lower(new.hapus_nama);
		
		thequery:= 'delete from '|| lower(new.hapus_nama) || ' where '|| lower(new.hapus_nama) || '_id = ' || new.temp_validasi_id;
		execute thequery;
		--raise notice 'sql %', thequery;
	end if;

	return new;
end;
$body$
language plpgsql volatile cost 100;
alter function validasi.validasi_hapus_data_update() owner to postgres;

drop trigger if exists validasi_hapus_data_trigger_update on validasi.hapus_data;
create trigger validasi_hapus_data_trigger_update
before update
on validasi.hapus_data
for each row
execute procedure validasi.validasi_hapus_data_update();

--========================================================================================================================
drop type if exists validasi.pegawai_type;
create type validasi.pegawai_type as
(
	pegawai_id bigint
	, propinsi_id integer
	, kabupaten_id integer
	, kecamatan_id integer
	, kelurahan_id integer
	, satker_id character varying(25)
	, kedudukan_id integer
	, jenis_pegawai_id integer
	, bank_id integer
	, nip_lama character varying(50)
	, nip_baru character varying(50)
	, nama character varying(100)
	, gelar_depan character varying(40)
	, gelar_belakang character varying(40)
	, tempat_lahir character varying(50)
	, tanggal_lahir date
	, jenis_kelamin character(1)
	, status_kawin integer
	, suku_bangsa character varying(50)
	, golongan_darah character(2)
	, email character varying(50)
	, alamat character varying(255)
	, rt character(5)
	, rw character(5)
	, telepon character varying(30)
	, kodepos character varying(20)
	, status_pegawai integer
	, kartu_pegawai character varying(50)
	, askes character varying(50)
	, taspen character varying(50)
	, npwp character varying(50)
	, nik character varying(50)
	, foto character varying(188)
	, no_rekening character varying(50)
	, tanggal_mati date
	, tanggal_pensiun date
	, tanggal_terusan date
	, tanggal_update date
	, tipe_pegawai_id character varying(20)
	, agama_id integer
	, satker_id_lama character varying(25)
	, foto_setengah character varying(188)
	, foto_blob text
	, foto_blob_other text
	, dosir_karpeg text
	, format_karpeg character varying(255)
	, ukuran_karpeg numeric
	, dosir_askes text
	, format_askes character varying(255)
	, ukuran_askes numeric
	, dosir_taspen text
	, format_taspen character varying(255)
	, ukuran_taspen numeric
	, dosir_npwp text
	, format_npwp character varying(255)
	, ukuran_npwp numeric
	, tanggal_pindah date
	, keterangan_pindah character varying(255)
	, tugas_tambahan integer
	, link_file_apps character varying(255)
	, link_file_apps_karpeg character varying(255)
	, link_file_apps_askes character varying(255)
	, link_file_apps_taspen character varying(255)
	, link_file_apps_npwp character varying(255)
	, hasil_asessment character varying(1000)
	, status_profil integer
	, password_skp character varying(255)
	, bup numeric
	, link_file_apps_kk character varying(255)
	, link_file_apps_istri character varying(255)
	, link_file_apps_ktp character varying(255)
	, link_file_apps_drh character varying(255)
	, link_file_apps_suami character varying(255)
	, format_drh character varying(255)
	, ukuran_drh numeric
	, format_ktp character varying(255)
	, ukuran_ktp numeric
	, format_kk character varying(255)
	, ukuran_kk numeric
	, format_istri character varying(255)
	, ukuran_istri numeric
	, format_suami character varying(255)
	, ukuran_suami numeric
	, ktp_pns character varying(255)
	, drh character varying(255)
	, kk character varying(255)
	, ktp_pasangan character varying(255)
	, tugas_tambahan_new character varying(1)
	, id_pns_siasn character varying(255)
	, jenis_mapel_id numeric
	, temp_validasi_id integer
	, temp_validasi_hapus_id integer
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
);

drop table if exists validasi.pegawai;
create table validasi.pegawai
(
	pegawai_id bigint
	, propinsi_id integer
	, kabupaten_id integer
	, kecamatan_id integer
	, kelurahan_id integer
	, satker_id character varying(25)
	, kedudukan_id integer
	, jenis_pegawai_id integer
	, bank_id integer
	, nip_lama character varying(50)
	, nip_baru character varying(50)
	, nama character varying(100)
	, gelar_depan character varying(40)
	, gelar_belakang character varying(40)
	, tempat_lahir character varying(50)
	, tanggal_lahir date
	, jenis_kelamin character(1)
	, status_kawin integer
	, suku_bangsa character varying(50)
	, golongan_darah character(2)
	, email character varying(50)
	, alamat character varying(255)
	, rt character(5)
	, rw character(5)
	, telepon character varying(30)
	, kodepos character varying(20)
	, status_pegawai integer
	, kartu_pegawai character varying(50)
	, askes character varying(50)
	, taspen character varying(50)
	, npwp character varying(50)
	, nik character varying(50)
	, foto character varying(188)
	, no_rekening character varying(50)
	, tanggal_mati date
	, tanggal_pensiun date
	, tanggal_terusan date
	, tanggal_update date
	, tipe_pegawai_id character varying(20)
	, agama_id integer
	, satker_id_lama character varying(25)
	, foto_setengah character varying(188)
	, foto_blob text
	, foto_blob_other text
	, dosir_karpeg text
	, format_karpeg character varying(255)
	, ukuran_karpeg numeric
	, dosir_askes text
	, format_askes character varying(255)
	, ukuran_askes numeric
	, dosir_taspen text
	, format_taspen character varying(255)
	, ukuran_taspen numeric
	, dosir_npwp text
	, format_npwp character varying(255)
	, ukuran_npwp numeric
	, tanggal_pindah date
	, keterangan_pindah character varying(255)
	, tugas_tambahan integer
	, link_file_apps character varying(255)
	, link_file_apps_karpeg character varying(255)
	, link_file_apps_askes character varying(255)
	, link_file_apps_taspen character varying(255)
	, link_file_apps_npwp character varying(255)
	, hasil_asessment character varying(1000)
	, status_profil integer
	, password_skp character varying(255)
	, bup numeric
	, link_file_apps_kk character varying(255)
	, link_file_apps_istri character varying(255)
	, link_file_apps_ktp character varying(255)
	, link_file_apps_drh character varying(255)
	, link_file_apps_suami character varying(255)
	, format_drh character varying(255)
	, ukuran_drh numeric
	, format_ktp character varying(255)
	, ukuran_ktp numeric
	, format_kk character varying(255)
	, ukuran_kk numeric
	, format_istri character varying(255)
	, ukuran_istri numeric
	, format_suami character varying(255)
	, ukuran_suami numeric
	, ktp_pns character varying(255)
	, drh character varying(255)
	, kk character varying(255)
	, ktp_pasangan character varying(255)
	, tugas_tambahan_new character varying(1)
	, id_pns_siasn character varying(255)
	, jenis_mapel_id numeric
	, last_create_user character varying(100)
	, last_create_date date
	, last_update_user character varying(100)
	, last_update_date date
	, last_create_satker character varying(25)
	, last_update_satker character varying(25)
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, perubahan_verifikator_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
	, temp_validasi_id integer NOT NULL
);

create or replace function validasi.validasi_pegawai(pegawaiid numeric, id character varying, rowid character varying)
returns setof validasi.pegawai_type as
$body$
declare
	cur refcursor;
	query text;
	rec validasi.pegawai_type%rowtype;
begin
	if coalesce(nullif(rowid, ''), null) is not null then
		query := '
		select
		a.pegawai_id
		, a.propinsi_id
		, a.kabupaten_id
		, a.kecamatan_id
		, a.kelurahan_id
		, a.satker_id
		, a.kedudukan_id
		, a.jenis_pegawai_id
		, a.bank_id
		, a.nip_lama
		, a.nip_baru
		, a.nama
		, a.gelar_depan
		, a.gelar_belakang
		, a.tempat_lahir
		, a.tanggal_lahir
		, a.jenis_kelamin
		, a.status_kawin
		, a.suku_bangsa
		, a.golongan_darah
		, a.email
		, a.alamat
		, a.rt
		, a.rw
		, a.telepon
		, a.kodepos
		, a.status_pegawai
		, a.kartu_pegawai
		, a.askes
		, a.taspen
		, a.npwp
		, a.nik
		, a.foto
		, a.no_rekening
		, a.tanggal_mati
		, a.tanggal_pensiun
		, a.tanggal_terusan
		, a.tanggal_update
		, a.tipe_pegawai_id
		, a.agama_id
		, a.satker_id_lama
		, a.foto_setengah
		, a.foto_blob
		, a.foto_blob_other
		, a.dosir_karpeg
		, a.format_karpeg
		, a.ukuran_karpeg
		, a.dosir_askes
		, a.format_askes
		, a.ukuran_askes
		, a.dosir_taspen
		, a.format_taspen
		, a.ukuran_taspen
		, a.dosir_npwp
		, a.format_npwp
		, a.ukuran_npwp
		, a.tanggal_pindah
		, a.keterangan_pindah
		, a.tugas_tambahan
		, a.link_file_apps
		, a.link_file_apps_karpeg
		, a.link_file_apps_askes
		, a.link_file_apps_taspen
		, a.link_file_apps_npwp
		, a.hasil_asessment
		, a.status_profil
		, a.password_skp
		, a.bup
		, a.link_file_apps_kk
		, a.link_file_apps_istri
		, a.link_file_apps_ktp
		, a.link_file_apps_drh
		, a.link_file_apps_suami
		, a.format_drh
		, a.ukuran_drh
		, a.format_ktp
		, a.ukuran_ktp
		, a.format_kk
		, a.ukuran_kk
		, a.format_istri
		, a.ukuran_istri
		, a.format_suami
		, a.ukuran_suami
		, a.ktp_pns
		, a.drh
		, a.kk
		, a.ktp_pasangan
		, a.tugas_tambahan_new
		, a.id_pns_siasn
		, a.jenis_mapel_id
		, a.temp_validasi_id, a.temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
		from
		(
			select
			a.pegawai_id
			, a.propinsi_id
			, a.kabupaten_id
			, a.kecamatan_id
			, a.kelurahan_id
			, a.satker_id
			, a.kedudukan_id
			, a.jenis_pegawai_id
			, a.bank_id
			, a.nip_lama
			, a.nip_baru
			, a.nama
			, a.gelar_depan
			, a.gelar_belakang
			, a.tempat_lahir
			, a.tanggal_lahir
			, a.jenis_kelamin
			, a.status_kawin
			, a.suku_bangsa
			, a.golongan_darah
			, a.email
			, a.alamat
			, a.rt
			, a.rw
			, a.telepon
			, a.kodepos
			, a.status_pegawai
			, a.kartu_pegawai
			, a.askes
			, a.taspen
			, a.npwp
			, a.nik
			, a.foto
			, a.no_rekening
			, a.tanggal_mati
			, a.tanggal_pensiun
			, a.tanggal_terusan
			, a.tanggal_update
			, a.tipe_pegawai_id
			, a.agama_id
			, a.satker_id_lama
			, a.foto_setengah
			, a.foto_blob
			, a.foto_blob_other
			, a.dosir_karpeg
			, a.format_karpeg
			, a.ukuran_karpeg
			, a.dosir_askes
			, a.format_askes
			, a.ukuran_askes
			, a.dosir_taspen
			, a.format_taspen
			, a.ukuran_taspen
			, a.dosir_npwp
			, a.format_npwp
			, a.ukuran_npwp
			, a.tanggal_pindah
			, a.keterangan_pindah
			, a.tugas_tambahan
			, a.link_file_apps
			, a.link_file_apps_karpeg
			, a.link_file_apps_askes
			, a.link_file_apps_taspen
			, a.link_file_apps_npwp
			, a.hasil_asessment
			, a.status_profil
			, a.password_skp
			, a.bup
			, a.link_file_apps_kk
			, a.link_file_apps_istri
			, a.link_file_apps_ktp
			, a.link_file_apps_drh
			, a.link_file_apps_suami
			, a.format_drh
			, a.ukuran_drh
			, a.format_ktp
			, a.ukuran_ktp
			, a.format_kk
			, a.ukuran_kk
			, a.format_istri
			, a.ukuran_istri
			, a.format_suami
			, a.ukuran_suami
			, a.ktp_pns
			, a.drh
			, a.kk
			, a.ktp_pasangan
			, a.tugas_tambahan_new
			, a.id_pns_siasn
			, a.jenis_mapel_id
			, a.temp_validasi_id, null temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
			from validasi.pegawai a
			where a.temp_validasi_id = '|| rowid ||'
			and a.pegawai_id = '|| pegawaiid ||'
		) a
		';
	  else
		query := '
		select
		a.pegawai_id
		, a.propinsi_id
		, a.kabupaten_id
		, a.kecamatan_id
		, a.kelurahan_id
		, a.satker_id
		, a.kedudukan_id
		, a.jenis_pegawai_id
		, a.bank_id
		, a.nip_lama
		, a.nip_baru
		, a.nama
		, a.gelar_depan
		, a.gelar_belakang
		, a.tempat_lahir
		, a.tanggal_lahir
		, a.jenis_kelamin
		, a.status_kawin
		, a.suku_bangsa
		, a.golongan_darah
		, a.email
		, a.alamat
		, a.rt
		, a.rw
		, a.telepon
		, a.kodepos
		, a.status_pegawai
		, a.kartu_pegawai
		, a.askes
		, a.taspen
		, a.npwp
		, a.nik
		, a.foto
		, a.no_rekening
		, a.tanggal_mati
		, a.tanggal_pensiun
		, a.tanggal_terusan
		, a.tanggal_update
		, a.tipe_pegawai_id
		, a.agama_id
		, a.satker_id_lama
		, a.foto_setengah
		, a.foto_blob
		, a.foto_blob_other
		, a.dosir_karpeg
		, a.format_karpeg
		, a.ukuran_karpeg
		, a.dosir_askes
		, a.format_askes
		, a.ukuran_askes
		, a.dosir_taspen
		, a.format_taspen
		, a.ukuran_taspen
		, a.dosir_npwp
		, a.format_npwp
		, a.ukuran_npwp
		, a.tanggal_pindah
		, a.keterangan_pindah
		, a.tugas_tambahan
		, a.link_file_apps
		, a.link_file_apps_karpeg
		, a.link_file_apps_askes
		, a.link_file_apps_taspen
		, a.link_file_apps_npwp
		, a.hasil_asessment
		, a.status_profil
		, a.password_skp
		, a.bup
		, a.link_file_apps_kk
		, a.link_file_apps_istri
		, a.link_file_apps_ktp
		, a.link_file_apps_drh
		, a.link_file_apps_suami
		, a.format_drh
		, a.ukuran_drh
		, a.format_ktp
		, a.ukuran_ktp
		, a.format_kk
		, a.ukuran_kk
		, a.format_istri
		, a.ukuran_istri
		, a.format_suami
		, a.ukuran_suami
		, a.ktp_pns
		, a.drh
		, a.kk
		, a.ktp_pasangan
		, a.tugas_tambahan_new
		, a.id_pns_siasn
		, a.jenis_mapel_id
		, a.temp_validasi_id, a.temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
		from
		(
			select
			a.pegawai_id
			, coalesce(b.propinsi_id, a.propinsi_id) propinsi_id
			, coalesce(b.kabupaten_id, a.kabupaten_id) kabupaten_id
			, coalesce(b.kecamatan_id, a.kecamatan_id) kecamatan_id
			, coalesce(b.kelurahan_id, a.kelurahan_id) kelurahan_id
			, coalesce(b.satker_id, a.satker_id) satker_id
			, coalesce(b.kedudukan_id, a.kedudukan_id) kedudukan_id
			, coalesce(b.jenis_pegawai_id, a.jenis_pegawai_id) jenis_pegawai_id
			, coalesce(b.bank_id, a.bank_id) bank_id
			, coalesce(b.nip_lama, a.nip_lama) nip_lama
			, coalesce(b.nip_baru, a.nip_baru) nip_baru
			, coalesce(b.nama, a.nama) nama
			, coalesce(b.gelar_depan, a.gelar_depan) gelar_depan
			, coalesce(b.gelar_belakang, a.gelar_belakang) gelar_belakang
			, coalesce(b.tempat_lahir, a.tempat_lahir) tempat_lahir
			, coalesce(b.tanggal_lahir, a.tanggal_lahir) tanggal_lahir
			, coalesce(b.jenis_kelamin, a.jenis_kelamin) jenis_kelamin
			, coalesce(b.status_kawin, a.status_kawin) status_kawin
			, coalesce(b.suku_bangsa, a.suku_bangsa) suku_bangsa
			, coalesce(b.golongan_darah, a.golongan_darah) golongan_darah
			, coalesce(b.email, a.email) email
			, coalesce(b.alamat, a.alamat) alamat
			, coalesce(b.rt, a.rt) rt
			, coalesce(b.rw, a.rw) rw
			, coalesce(b.telepon, a.telepon) telepon
			, coalesce(b.kodepos, a.kodepos) kodepos
			, coalesce(b.status_pegawai, a.status_pegawai) status_pegawai
			, coalesce(b.kartu_pegawai, a.kartu_pegawai) kartu_pegawai
			, coalesce(b.askes, a.askes) askes
			, coalesce(b.taspen, a.taspen) taspen
			, coalesce(b.npwp, a.npwp) npwp
			, coalesce(b.nik, a.nik) nik
			, coalesce(b.foto, a.foto) foto
			, coalesce(b.no_rekening, a.no_rekening) no_rekening
			, coalesce(b.tanggal_mati, a.tanggal_mati) tanggal_mati
			, coalesce(b.tanggal_pensiun, a.tanggal_pensiun) tanggal_pensiun
			, coalesce(b.tanggal_terusan, a.tanggal_terusan) tanggal_terusan
			, coalesce(b.tanggal_update, a.tanggal_update) tanggal_update
			, coalesce(b.tipe_pegawai_id, a.tipe_pegawai_id) tipe_pegawai_id
			, coalesce(b.agama_id, a.agama_id) agama_id
			, coalesce(b.satker_id_lama, a.satker_id_lama) satker_id_lama
			, coalesce(b.foto_setengah, a.foto_setengah) foto_setengah
			, coalesce(b.foto_blob, a.foto_blob) foto_blob
			, coalesce(b.foto_blob_other, a.foto_blob_other) foto_blob_other
			, coalesce(b.dosir_karpeg, a.dosir_karpeg) dosir_karpeg
			, coalesce(b.format_karpeg, a.format_karpeg) format_karpeg
			, coalesce(b.ukuran_karpeg, a.ukuran_karpeg) ukuran_karpeg
			, coalesce(b.dosir_askes, a.dosir_askes) dosir_askes
			, coalesce(b.format_askes, a.format_askes) format_askes
			, coalesce(b.ukuran_askes, a.ukuran_askes) ukuran_askes
			, coalesce(b.dosir_taspen, a.dosir_taspen) dosir_taspen
			, coalesce(b.format_taspen, a.format_taspen) format_taspen
			, coalesce(b.ukuran_taspen, a.ukuran_taspen) ukuran_taspen
			, coalesce(b.dosir_npwp, a.dosir_npwp) dosir_npwp
			, coalesce(b.format_npwp, a.format_npwp) format_npwp
			, coalesce(b.ukuran_npwp, a.ukuran_npwp) ukuran_npwp
			, coalesce(b.tanggal_pindah, a.tanggal_pindah) tanggal_pindah
			, coalesce(b.keterangan_pindah, a.keterangan_pindah) keterangan_pindah
			, coalesce(b.tugas_tambahan, a.tugas_tambahan) tugas_tambahan
			, coalesce(b.link_file_apps, a.link_file_apps) link_file_apps
			, coalesce(b.link_file_apps_karpeg, a.link_file_apps_karpeg) link_file_apps_karpeg
			, coalesce(b.link_file_apps_askes, a.link_file_apps_askes) link_file_apps_askes
			, coalesce(b.link_file_apps_taspen, a.link_file_apps_taspen) link_file_apps_taspen
			, coalesce(b.link_file_apps_npwp, a.link_file_apps_npwp) link_file_apps_npwp
			, coalesce(b.hasil_asessment, a.hasil_asessment) hasil_asessment
			, coalesce(b.status_profil, a.status_profil) status_profil
			, coalesce(b.password_skp, a.password_skp) password_skp
			, coalesce(b.bup, a.bup) bup
			, coalesce(b.link_file_apps_kk, a.link_file_apps_kk) link_file_apps_kk
			, coalesce(b.link_file_apps_istri, a.link_file_apps_istri) link_file_apps_istri
			, coalesce(b.link_file_apps_ktp, a.link_file_apps_ktp) link_file_apps_ktp
			, coalesce(b.link_file_apps_drh, a.link_file_apps_drh) link_file_apps_drh
			, coalesce(b.link_file_apps_suami, a.link_file_apps_suami) link_file_apps_suami
			, coalesce(b.format_drh, a.format_drh) format_drh
			, coalesce(b.ukuran_drh, a.ukuran_drh) ukuran_drh
			, coalesce(b.format_ktp, a.format_ktp) format_ktp
			, coalesce(b.ukuran_ktp, a.ukuran_ktp) ukuran_ktp
			, coalesce(b.format_kk, a.format_kk) format_kk
			, coalesce(b.ukuran_kk, a.ukuran_kk) ukuran_kk
			, coalesce(b.format_istri, a.format_istri) format_istri
			, coalesce(b.ukuran_istri, a.ukuran_istri) ukuran_istri
			, coalesce(b.format_suami, a.format_suami) format_suami
			, coalesce(b.ukuran_suami, a.ukuran_suami) ukuran_suami
			, coalesce(b.ktp_pns, a.ktp_pns) ktp_pns
			, coalesce(b.drh, a.drh) drh
			, coalesce(b.kk, a.kk) kk
			, coalesce(b.ktp_pasangan, a.ktp_pasangan) ktp_pasangan
			, coalesce(b.tugas_tambahan_new, a.tugas_tambahan_new) tugas_tambahan_new
			, coalesce(b.id_pns_siasn, a.id_pns_siasn) id_pns_siasn
			, coalesce(b.jenis_mapel_id, a.jenis_mapel_id) jenis_mapel_id
			, b.temp_validasi_id, c.temp_validasi_id temp_validasi_hapus_id, b.validasi, b.validator, b.perubahan_data, b.tipe_perubahan_data, b.tanggal_validasi
			from pegawai a
			left join validasi.pegawai b on a.pegawai_id = b.pegawai_id and b.validasi is null
			left join validasi.hapus_data c on upper(c.hapus_nama)::text = upper(''pegawai'')::text and a.pegawai_id = c.temp_validasi_id::numeric and c.validasi is null
			where a.pegawai_id = '|| pegawaiid ||'
			union all
			select
			a.pegawai_id
			, a.propinsi_id
			, a.kabupaten_id
			, a.kecamatan_id
			, a.kelurahan_id
			, a.satker_id
			, a.kedudukan_id
			, a.jenis_pegawai_id
			, a.bank_id
			, a.nip_lama
			, a.nip_baru
			, a.nama
			, a.gelar_depan
			, a.gelar_belakang
			, a.tempat_lahir
			, a.tanggal_lahir
			, a.jenis_kelamin
			, a.status_kawin
			, a.suku_bangsa
			, a.golongan_darah
			, a.email
			, a.alamat
			, a.rt
			, a.rw
			, a.telepon
			, a.kodepos
			, a.status_pegawai
			, a.kartu_pegawai
			, a.askes
			, a.taspen
			, a.npwp
			, a.nik
			, a.foto
			, a.no_rekening
			, a.tanggal_mati
			, a.tanggal_pensiun
			, a.tanggal_terusan
			, a.tanggal_update
			, a.tipe_pegawai_id
			, a.agama_id
			, a.satker_id_lama
			, a.foto_setengah
			, a.foto_blob
			, a.foto_blob_other
			, a.dosir_karpeg
			, a.format_karpeg
			, a.ukuran_karpeg
			, a.dosir_askes
			, a.format_askes
			, a.ukuran_askes
			, a.dosir_taspen
			, a.format_taspen
			, a.ukuran_taspen
			, a.dosir_npwp
			, a.format_npwp
			, a.ukuran_npwp
			, a.tanggal_pindah
			, a.keterangan_pindah
			, a.tugas_tambahan
			, a.link_file_apps
			, a.link_file_apps_karpeg
			, a.link_file_apps_askes
			, a.link_file_apps_taspen
			, a.link_file_apps_npwp
			, a.hasil_asessment
			, a.status_profil
			, a.password_skp
			, a.bup
			, a.link_file_apps_kk
			, a.link_file_apps_istri
			, a.link_file_apps_ktp
			, a.link_file_apps_drh
			, a.link_file_apps_suami
			, a.format_drh
			, a.ukuran_drh
			, a.format_ktp
			, a.ukuran_ktp
			, a.format_kk
			, a.ukuran_kk
			, a.format_istri
			, a.ukuran_istri
			, a.format_suami
			, a.ukuran_suami
			, a.ktp_pns
			, a.drh
			, a.kk
			, a.ktp_pasangan
			, a.tugas_tambahan_new
			, a.id_pns_siasn
			, a.jenis_mapel_id
			, a.temp_validasi_id, null temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
			from validasi.pegawai a
			where a.validasi is null and a.pegawai_id is null
			and a.pegawai_id = '|| pegawaiid ||'
		) a
		where 1=1
		';

		if coalesce(nullif(id, ''), null) is not null then
			query := query || ' and a.pegawai_id = ' || id;
		end if;
		raise notice 'sql %', query;
		
	end if;
		
	open cur for execute query;
		fetch cur into rec;
		while found loop
			return next rec;
		fetch cur into rec;
			end loop;
	close cur;
end;
$body$
language plpgsql volatile strict cost 100 rows 1000;
alter function validasi.validasi_pegawai(numeric, character varying, character varying) owner to postgres;

create or replace function validasi.validasi_pegawai()
  returns trigger as
$body$
declare

    rec record;
    pinfoperubahan character varying;
    thequery character varying;
    
    begin

	if new.validasi = 1 or new.validasi is null then
		pinfoperubahan := '{ "0" : "0" ';
		if new.pegawai_id is null then
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('propinsi_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kabupaten_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kecamatan_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kelurahan_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('satker_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kedudukan_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_pegawai_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('bank_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nip_lama'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nip_baru'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nama'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gelar_depan'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gelar_belakang'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tempat_lahir'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_lahir'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_kelamin'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('status_kawin'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('suku_bangsa'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('golongan_darah'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('email'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('alamat'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('rt'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('rw'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('telepon'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kodepos'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('status_pegawai'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kartu_pegawai'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('askes'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('taspen'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('npwp'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nik'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_rekening'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tipe_pegawai_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('agama_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_pindah'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('keterangan_pindah'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tugas_tambahan'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('bup'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('ktp_pns'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('drh'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kk'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('ktp_pasangan'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tugas_tambahan_new'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_mapel_id'), ''::character varying, 'valsixdatabaru'::character varying);
			
		else
			for rec in select * from pegawai a where a.pegawai_id = new.pegawai_id
			loop
				if new.validasi is null then
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('propinsi_id'), new.propinsi_id::character varying, rec.propinsi_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kabupaten_id'), new.kabupaten_id::character varying, rec.kabupaten_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kecamatan_id'), new.kecamatan_id::character varying, rec.kecamatan_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kelurahan_id'), new.kelurahan_id::character varying, rec.kelurahan_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('satker_id'), new.satker_id::character varying, rec.satker_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kedudukan_id'), new.kedudukan_id::character varying, rec.kedudukan_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_pegawai_id'), new.jenis_pegawai_id::character varying, rec.jenis_pegawai_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('bank_id'), new.bank_id::character varying, rec.bank_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nip_lama'), new.nip_lama::character varying, rec.nip_lama::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nip_baru'), new.nip_baru::character varying, rec.nip_baru::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nama'), new.nama::character varying, rec.nama::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gelar_depan'), new.gelar_depan::character varying, rec.gelar_depan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gelar_belakang'), new.gelar_belakang::character varying, rec.gelar_belakang::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tempat_lahir'), new.tempat_lahir::character varying, rec.tempat_lahir::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_lahir'), new.tanggal_lahir::character varying, rec.tanggal_lahir::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_kelamin'), new.jenis_kelamin::character varying, rec.jenis_kelamin::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('status_kawin'), new.status_kawin::character varying, rec.status_kawin::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('suku_bangsa'), new.suku_bangsa::character varying, rec.suku_bangsa::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('golongan_darah'), new.golongan_darah::character varying, rec.golongan_darah::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('email'), new.email::character varying, rec.email::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('alamat'), new.alamat::character varying, rec.alamat::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('rt'), new.rt::character varying, rec.rt::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('rw'), new.rw::character varying, rec.rw::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('telepon'), new.telepon::character varying, rec.telepon::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kodepos'), new.kodepos::character varying, rec.kodepos::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('status_pegawai'), new.status_pegawai::character varying, rec.status_pegawai::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kartu_pegawai'), new.kartu_pegawai::character varying, rec.kartu_pegawai::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('askes'), new.askes::character varying, rec.askes::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('taspen'), new.taspen::character varying, rec.taspen::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('npwp'), new.npwp::character varying, rec.npwp::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nik'), new.nik::character varying, rec.nik::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_rekening'), new.no_rekening::character varying, rec.no_rekening::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tipe_pegawai_id'), new.tipe_pegawai_id::character varying, rec.tipe_pegawai_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('agama_id'), new.agama_id::character varying, rec.agama_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_pindah'), new.tanggal_pindah::character varying, rec.tanggal_pindah::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('keterangan_pindah'), new.keterangan_pindah::character varying, rec.keterangan_pindah::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tugas_tambahan'), new.tugas_tambahan::character varying, rec.tugas_tambahan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('bup'), new.bup::character varying, rec.bup::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('ktp_pns'), new.ktp_pns::character varying, rec.ktp_pns::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('drh'), new.drh::character varying, rec.drh::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kk'), new.kk::character varying, rec.kk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('ktp_pasangan'), new.ktp_pasangan::character varying, rec.ktp_pasangan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tugas_tambahan_new'), new.tugas_tambahan_new::character varying, rec.tugas_tambahan_new::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_mapel_id'), new.jenis_mapel_id::character varying, rec.jenis_mapel_id::character varying);
					
				else
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('propinsi_id'), rec.propinsi_id::character varying, new.propinsi_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kabupaten_id'), rec.kabupaten_id::character varying, new.kabupaten_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kecamatan_id'), rec.kecamatan_id::character varying, new.kecamatan_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kelurahan_id'), rec.kelurahan_id::character varying, new.kelurahan_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('satker_id'), rec.satker_id::character varying, new.satker_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kedudukan_id'), rec.kedudukan_id::character varying, new.kedudukan_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_pegawai_id'), rec.jenis_pegawai_id::character varying, new.jenis_pegawai_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('bank_id'), rec.bank_id::character varying, new.bank_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nip_lama'), rec.nip_lama::character varying, new.nip_lama::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nip_baru'), rec.nip_baru::character varying, new.nip_baru::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nama'), rec.nama::character varying, new.nama::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gelar_depan'), rec.gelar_depan::character varying, new.gelar_depan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gelar_belakang'), rec.gelar_belakang::character varying, new.gelar_belakang::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tempat_lahir'), rec.tempat_lahir::character varying, new.tempat_lahir::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_lahir'), rec.tanggal_lahir::character varying, new.tanggal_lahir::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_kelamin'), rec.jenis_kelamin::character varying, new.jenis_kelamin::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('status_kawin'), rec.status_kawin::character varying, new.status_kawin::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('suku_bangsa'), rec.suku_bangsa::character varying, new.suku_bangsa::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('golongan_darah'), rec.golongan_darah::character varying, new.golongan_darah::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('email'), rec.email::character varying, new.email::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('alamat'), rec.alamat::character varying, new.alamat::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('rt'), rec.rt::character varying, new.rt::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('rw'), rec.rw::character varying, new.rw::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('telepon'), rec.telepon::character varying, new.telepon::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kodepos'), rec.kodepos::character varying, new.kodepos::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('status_pegawai'), rec.status_pegawai::character varying, new.status_pegawai::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kartu_pegawai'), rec.kartu_pegawai::character varying, new.kartu_pegawai::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('askes'), rec.askes::character varying, new.askes::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('taspen'), rec.taspen::character varying, new.taspen::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('npwp'), rec.npwp::character varying, new.npwp::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('nik'), rec.nik::character varying, new.nik::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_rekening'), rec.no_rekening::character varying, new.no_rekening::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tipe_pegawai_id'), rec.tipe_pegawai_id::character varying, new.tipe_pegawai_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('agama_id'), rec.agama_id::character varying, new.agama_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_pindah'), rec.tanggal_pindah::character varying, new.tanggal_pindah::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('keterangan_pindah'), rec.keterangan_pindah::character varying, new.keterangan_pindah::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tugas_tambahan'), rec.tugas_tambahan::character varying, new.tugas_tambahan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('bup'), rec.bup::character varying, new.bup::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('ktp_pns'), rec.ktp_pns::character varying, new.ktp_pns::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('drh'), rec.drh::character varying, new.drh::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kk'), rec.kk::character varying, new.kk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('ktp_pasangan'), rec.ktp_pasangan::character varying, new.ktp_pasangan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tugas_tambahan_new'), rec.tugas_tambahan_new::character varying, new.tugas_tambahan_new::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_mapel_id'), rec.jenis_mapel_id::character varying, new.jenis_mapel_id::character varying);

					/*, foto character varying(188)
					, tanggal_mati date
					, tanggal_pensiun date
					, tanggal_terusan date
					, tanggal_update date
					, satker_id_lama character varying(25)
					, foto_setengah character varying(188)
					, foto_blob text
					, foto_blob_other text
					, dosir_karpeg text
					, format_karpeg character varying(255)
					, ukuran_karpeg numeric
					, dosir_askes text
					, format_askes character varying(255)
					, ukuran_askes numeric
					, dosir_taspen text
					, format_taspen character varying(255)
					, ukuran_taspen numeric
					, dosir_npwp text
					, format_npwp character varying(255)
					, ukuran_npwp numeric
					, link_file_apps character varying(255)
					, link_file_apps_karpeg character varying(255)
					, link_file_apps_askes character varying(255)
					, link_file_apps_taspen character varying(255)
					, link_file_apps_npwp character varying(255)
					, hasil_asessment character varying(1000)
					, status_profil integer
					, password_skp character varying(255)
					, link_file_apps_kk character varying(255)
					, link_file_apps_istri character varying(255)
					, link_file_apps_ktp character varying(255)
					, link_file_apps_drh character varying(255)
					, link_file_apps_suami character varying(255)
					, format_drh character varying(255)
					, ukuran_drh numeric
					, format_ktp character varying(255)
					, ukuran_ktp numeric
					, format_kk character varying(255)
					, ukuran_kk numeric
					, format_istri character varying(255)
					, ukuran_istri numeric
					, format_suami character varying(255)
					, ukuran_suami numeric
					, id_pns_siasn character varying(255)*/

				end if;
				
			end loop;
		end if;
		
		pinfoperubahan:= pinfoperubahan || ' }';
		--raise notice 'sql %', pinfoperubahan;
	end if;
	
	if new.validasi = 1 then 
		if new.pegawai_id is null then
			if new.tanggal_validasi is null then
				new.perubahan_verifikator_data= pinfoperubahan;
			else
				--raise notice 'sql %', '';
			end if;
		else
			if new.tanggal_validasi is null then
				new.perubahan_verifikator_data= pinfoperubahan;
			else
				select validasi.vupdateinfo('pegawai', new.pegawai_id, new.temp_validasi_id, new.last_update_user, 99) into thequery;

				if thequery is not null then
					--new.last_level:= old.last_level;
					execute thequery;
				end if;
			end if;
			--raise notice 'sql %', thequery;
			--return null;
		end if;
	elsif new.validasi = 2 then 
		--raise notice 'sql %', '';
	else
		new.perubahan_data := pinfoperubahan;
	end if;

	return new;
    end;
$body$
language plpgsql volatile cost 100;
alter function validasi.validasi_pegawai() owner to postgres;

drop trigger if exists validasi_pegawai_trigger on validasi.pegawai;
create trigger validasi_pegawai_trigger
before insert or update
on validasi.pegawai
for each row
execute procedure validasi.validasi_pegawai();

--========================================================================================================================
drop function if exists validasi.validasi_pegawai_pangkat_riwayat(numeric, character varying, character varying);
drop type if exists validasi.pangkat_riwayat_type;
create type validasi.pangkat_riwayat_type as
(
	pangkat_riwayat_id integer
	, pegawai_id bigint
	, pejabat_penetap_id integer
	, pangkat_id integer
	, stlud character varying(80)
	, no_stlud character varying(80)
	, tanggal_stlud date
	, no_nota character varying(45)
	, tanggal_nota date
	, no_sk character varying(50)
	, tanggal_sk date
	, tmt_pangkat date
	, kredit numeric
	, jenis_kp integer
	, keterangan character varying(255)
	, masa_kerja_tahun integer
	, masa_kerja_bulan integer
	, tanggal_update date
	, flag_data_terakhir integer
	, pejabat_penetap character varying(255)
	, foto_blob text
	, format character varying(255)
	, ukuran numeric
	, user_app_id integer
	, gaji_pokok integer
	, temp_validasi_id integer
	, temp_validasi_hapus_id integer
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
);

drop table if exists validasi.pangkat_riwayat;
create table validasi.pangkat_riwayat
(
	pangkat_riwayat_id integer
	, pegawai_id bigint
	, pejabat_penetap_id integer
	, pangkat_id integer
	, stlud character varying(80)
	, no_stlud character varying(80)
	, tanggal_stlud date
	, no_nota character varying(45)
	, tanggal_nota date
	, no_sk character varying(50)
	, tanggal_sk date
	, tmt_pangkat date
	, kredit numeric
	, jenis_kp integer
	, keterangan character varying(255)
	, masa_kerja_tahun integer
	, masa_kerja_bulan integer
	, tanggal_update date
	, flag_data_terakhir integer default 1
	, pejabat_penetap character varying(255)
	, foto_blob text
	, format character varying(255)
	, ukuran numeric
	, user_app_id integer
	, gaji_pokok integer
	, last_create_user character varying(100)
	, last_create_date date
	, last_update_user character varying(100)
	, last_update_date date
	, last_create_satker character varying(25)
	, last_update_satker character varying(25)
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, perubahan_verifikator_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
	, temp_validasi_id integer NOT NULL
	, constraint vpangkat_riwayat_pkey primary key (temp_validasi_id)
);

create or replace function validasi.validasi_pegawai_pangkat_riwayat(pegawaiid numeric, id character varying, rowid character varying)
returns setof validasi.pangkat_riwayat_type as
$body$
declare
	cur refcursor;
	query text;
	rec validasi.pangkat_riwayat_type%rowtype;
begin
	if coalesce(nullif(rowid, ''), null) is not null then
		query := '
		select
		a.pangkat_riwayat_id, a.pegawai_id
		, a.pejabat_penetap_id, a.pangkat_id, a.stlud, a.no_stlud, a.tanggal_stlud, a.no_nota, a.tanggal_nota
		, a.no_sk, a.tanggal_sk, a.tmt_pangkat, a.kredit, a.jenis_kp, a.keterangan
		, a.masa_kerja_tahun, a.masa_kerja_bulan, a.tanggal_update, a.flag_data_terakhir, a.pejabat_penetap
		, a.foto_blob, a.format, a.ukuran, a.user_app_id, a.gaji_pokok
		, a.temp_validasi_id, a.temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
		from
		(
			select
			a.pangkat_riwayat_id, a.pegawai_id
			, a.pejabat_penetap_id, a.pangkat_id, a.stlud, a.no_stlud, a.tanggal_stlud, a.no_nota, a.tanggal_nota
			, a.no_sk, a.tanggal_sk, a.tmt_pangkat, a.kredit, a.jenis_kp, a.keterangan
			, a.masa_kerja_tahun, a.masa_kerja_bulan, a.tanggal_update, a.flag_data_terakhir, a.pejabat_penetap
			, a.foto_blob, a.format, a.ukuran, a.user_app_id, a.gaji_pokok
			, a.temp_validasi_id, null temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
			from validasi.pangkat_riwayat a
			where a.temp_validasi_id = '|| rowid ||'
			and a.pegawai_id = '|| pegawaiid ||'
		) a
		';
	  else
		query := '
		select
		a.pangkat_riwayat_id, a.pegawai_id
		, a.pejabat_penetap_id, a.pangkat_id, a.stlud, a.no_stlud, a.tanggal_stlud, a.no_nota, a.tanggal_nota
		, a.no_sk, a.tanggal_sk, a.tmt_pangkat, a.kredit, a.jenis_kp, a.keterangan
		, a.masa_kerja_tahun, a.masa_kerja_bulan, a.tanggal_update, a.flag_data_terakhir, a.pejabat_penetap
		, a.foto_blob, a.format, a.ukuran, a.user_app_id, a.gaji_pokok
		, a.temp_validasi_id, a.temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
		from
		(
			select
			a.pangkat_riwayat_id, a.pegawai_id
			, coalesce(b.pejabat_penetap_id, a.pejabat_penetap_id) pejabat_penetap_id
			, coalesce(b.pangkat_id, a.pangkat_id) pangkat_id
			, coalesce(b.stlud, a.stlud) stlud
			, coalesce(b.no_stlud, a.no_stlud) no_stlud
			, coalesce(b.tanggal_stlud, a.tanggal_stlud) tanggal_stlud
			, coalesce(b.no_nota, a.no_nota) no_nota
			, coalesce(b.tanggal_nota, a.tanggal_nota) tanggal_nota
			, coalesce(b.no_sk, a.no_sk) no_sk
			, coalesce(b.tanggal_sk, a.tanggal_sk) tanggal_sk
			, coalesce(b.tmt_pangkat, a.tmt_pangkat) tmt_pangkat
			, coalesce(b.kredit, a.kredit) kredit
			, coalesce(b.jenis_kp, a.jenis_kp) jenis_kp
			, coalesce(b.keterangan, a.keterangan) keterangan
			, coalesce(b.masa_kerja_tahun, a.masa_kerja_tahun) masa_kerja_tahun
			, coalesce(b.masa_kerja_bulan, a.masa_kerja_bulan) masa_kerja_bulan
			, coalesce(b.tanggal_update, a.tanggal_update) tanggal_update
			, coalesce(b.flag_data_terakhir, a.flag_data_terakhir) flag_data_terakhir
			, coalesce(b.pejabat_penetap, a.pejabat_penetap) pejabat_penetap
			, coalesce(b.foto_blob, a.foto_blob) foto_blob
			, coalesce(b.format, a.format) format
			, coalesce(b.ukuran, a.ukuran) ukuran
			, coalesce(b.gaji_pokok, a.gaji_pokok) user_app_id
			, coalesce(b.gaji_pokok, a.gaji_pokok) gaji_pokok
			, b.temp_validasi_id, c.temp_validasi_id temp_validasi_hapus_id, b.validasi, b.validator, b.perubahan_data, b.tipe_perubahan_data, b.tanggal_validasi
			from pangkat_riwayat a
			left join validasi.pangkat_riwayat b on a.pangkat_riwayat_id = b.pangkat_riwayat_id and b.validasi is null
			left join validasi.hapus_data c on upper(c.hapus_nama)::text = upper(''pangkat_riwayat'')::text and a.pangkat_riwayat_id = c.temp_validasi_id::numeric and c.validasi is null
			where a.pegawai_id = '|| pegawaiid ||'
			union all
			select
			a.pangkat_riwayat_id, a.pegawai_id
			, a.pejabat_penetap_id, a.pangkat_id, a.stlud, a.no_stlud, a.tanggal_stlud, a.no_nota, a.tanggal_nota
			, a.no_sk, a.tanggal_sk, a.tmt_pangkat, a.kredit, a.jenis_kp, a.keterangan
			, a.masa_kerja_tahun, a.masa_kerja_bulan, a.tanggal_update, a.flag_data_terakhir, a.pejabat_penetap
			, a.foto_blob, a.format, a.ukuran, a.user_app_id, a.gaji_pokok
			, a.temp_validasi_id, null temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
			from validasi.pangkat_riwayat a
			where a.validasi is null and a.pangkat_riwayat_id is null
			and a.pegawai_id = '|| pegawaiid ||'
		) a
		where 1=1
		';

		if coalesce(nullif(id, ''), null) is not null then
			query := query || ' and a.pangkat_riwayat_id = ' || id;
		end if;
		--raise notice 'sql %', query;
		
	end if;
		
	open cur for execute query;
		fetch cur into rec;
		while found loop
			return next rec;
		fetch cur into rec;
			end loop;
	close cur;
end;
$body$
language plpgsql volatile strict cost 100 rows 1000;
alter function validasi.validasi_pegawai_pangkat_riwayat(numeric, character varying, character varying) owner to postgres;

create or replace function validasi.p_pangkat_riwayat()
  returns trigger as
$body$
declare

    rec record;
    pinfoperubahan character varying;
    thequery character varying;
    
    begin

	if new.validasi = 1 or new.validasi is null then
		pinfoperubahan := '{ "0" : "0" ';
		if new.pangkat_riwayat_id is null then
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pangkat_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('stlud'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_stlud'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_stlud'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_nota'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_nota'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_sk'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_sk'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tmt_pangkat'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kredit'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_kp'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('keterangan'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_tahun'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_bulan'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gaji_pokok'), ''::character varying, 'valsixdatabaru'::character varying);

		else
			for rec in select * from pangkat_riwayat a where a.pegawai_id = new.pegawai_id and a.pangkat_riwayat_id = new.pangkat_riwayat_id
			loop
				if new.validasi is null then
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap_id'), new.pejabat_penetap_id::character varying, rec.pejabat_penetap_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap'), new.pejabat_penetap::character varying, rec.pejabat_penetap::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pangkat_id'), new.pangkat_id::character varying, rec.pangkat_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('stlud'), new.stlud::character varying, rec.stlud::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_stlud'), new.no_stlud::character varying, rec.no_stlud::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_stlud'), new.tanggal_stlud::character varying, rec.tanggal_stlud::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_nota'), new.no_nota::character varying, rec.no_nota::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_nota'), new.tanggal_nota::character varying, rec.tanggal_nota::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_sk'), new.no_sk::character varying, rec.no_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_sk'), new.tanggal_sk::character varying, rec.tanggal_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tmt_pangkat'), new.tmt_pangkat::character varying, rec.tmt_pangkat::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kredit'), new.kredit::character varying, rec.kredit::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_kp'), new.jenis_kp::character varying, rec.jenis_kp::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('keterangan'), new.keterangan::character varying, rec.keterangan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_tahun'), new.masa_kerja_tahun::character varying, rec.masa_kerja_tahun::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_bulan'), new.masa_kerja_bulan::character varying, rec.masa_kerja_bulan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gaji_pokok'), new.gaji_pokok::character varying, rec.gaji_pokok::character varying);
					
				else
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap_id'), rec.pejabat_penetap_id::character varying, new.pejabat_penetap_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap'), rec.pejabat_penetap::character varying, new.pejabat_penetap::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pangkat_id'), rec.pangkat_id::character varying, new.pangkat_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('stlud'), rec.stlud::character varying, new.stlud::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_stlud'), rec.no_stlud::character varying, new.no_stlud::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_stlud'), rec.tanggal_stlud::character varying, new.tanggal_stlud::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_nota'), rec.no_nota::character varying, new.no_nota::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_nota'), rec.tanggal_nota::character varying, new.tanggal_nota::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_sk'), rec.no_sk::character varying, new.no_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_sk'), rec.tanggal_sk::character varying, new.tanggal_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tmt_pangkat'), rec.tmt_pangkat::character varying, new.tmt_pangkat::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('kredit'), rec.kredit::character varying, new.kredit::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_kp'), rec.jenis_kp::character varying, new.jenis_kp::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('keterangan'), rec.keterangan::character varying, new.keterangan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_tahun'), rec.masa_kerja_tahun::character varying, new.masa_kerja_tahun::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_bulan'), rec.masa_kerja_bulan::character varying, new.masa_kerja_bulan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gaji_pokok'), rec.gaji_pokok::character varying, new.gaji_pokok::character varying);

				end if;
				
			end loop;
		end if;
		
		pinfoperubahan:= pinfoperubahan || ' }';
		--raise notice 'sql %', pinfoperubahan;
	end if;
	
	if new.validasi = 1 then 
		if new.pangkat_riwayat_id is null then
			if new.tanggal_validasi is null then
				new.perubahan_verifikator_data= pinfoperubahan;
			else
				insert into pangkat_riwayat 
				(
					pangkat_riwayat_id, pegawai_id, pejabat_penetap_id, pejabat_penetap, pangkat_id, stlud, no_stlud, 
					tanggal_stlud, no_nota, tanggal_nota, no_sk, tanggal_sk, tmt_pangkat, kredit, jenis_kp, 
					keterangan, masa_kerja_tahun, masa_kerja_bulan, gaji_pokok, last_create_user, last_create_date, last_create_satker, last_update_user, last_update_date, last_update_satker
				)
				values 
				(
					(select coalesce(max(pangkat_riwayat_id), 0) + 1 from pangkat_riwayat)
					, new.pegawai_id
					, new.pejabat_penetap_id
					, new.pejabat_penetap
					, new.pangkat_id
					, new.stlud
					, new.no_stlud
					, new.tanggal_stlud
					, new.no_nota
					, new.tanggal_nota
					, new.no_sk
					, new.tanggal_sk
					, new.tmt_pangkat
					, new.kredit
					, new.jenis_kp
					, new.keterangan
					, new.masa_kerja_tahun
					, new.masa_kerja_bulan
					, new.gaji_pokok
					, new.last_create_user, new.last_create_date, new.last_create_satker
					, new.last_update_user, new.last_update_date, new.last_update_satker
				);
				--raise notice 'sql %', '';
			end if;
		else
			if new.tanggal_validasi is null then
				new.perubahan_verifikator_data= pinfoperubahan;
			else
				select validasi.vupdateinfo('pangkat_riwayat', new.pangkat_riwayat_id, new.temp_validasi_id, new.last_update_user, 99) into thequery;

				if thequery is not null then
					--new.last_level:= old.last_level;
					execute thequery;
				end if;
			end if;
			--raise notice 'sql %', thequery;
			--return null;
		end if;
	elsif new.validasi = 2 then 
		--raise notice 'sql %', '';
	else
		new.perubahan_data := pinfoperubahan;
	end if;

	return new;
    end;
$body$
language plpgsql volatile cost 100;
alter function validasi.p_pangkat_riwayat() owner to postgres;

drop trigger if exists t_pangkat_riwayat on validasi.pangkat_riwayat;
create trigger t_pangkat_riwayat
before insert or update
on validasi.pangkat_riwayat
for each row
execute procedure validasi.p_pangkat_riwayat();

--========================================================================================================================
drop table if exists validasi.jabatan_riwayat;
create table validasi.jabatan_riwayat
(
	jabatan_riwayat_id integer
	, pegawai_id bigint
	, pejabat_penetap_id integer
	, eselon_id integer
	, jabatan_fungsional_id character varying(50)
	, no_sk character varying(50)
	, tanggal_sk date
	, tmt_jabatan date
	, tmt_eselon date
	, nama character varying(255)
	, no_pelantikan character varying(50)
	, tanggal_pelantikan date
	, tunjangan integer
	, kredit integer
	, bulan_dibayar date
	, sudah_dibayar integer
	, tanggal_update date
	, flag_data_terakhir integer default 1
	, satker_id character varying(100)
	, pejabat_penetap character varying(255)
	, foto_blob text
	, tmt_jabatan_fungsional date
	, tmt_tugas_tambahan date
	, format character varying(255)
	, ukuran numeric
	, user_app_id integer
	, last_create_user character varying(100)
	, last_create_date date
	, last_update_user character varying(100)
	, last_update_date date
	, last_create_satker character varying(25)
	, last_update_satker character varying(25)
	, keterangan_bup character varying(100)
	, mata_pelajaran character varying(255)
	, kode_jabatan character varying(6)
	, angka_kredit numeric
	, tentang_jabatan character varying(250)
	, jenis_jabatan character varying(255)
	, satker character varying(255)
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, perubahan_verifikator_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
	, temp_validasi_id integer NOT NULL
	, constraint vjabatan_riwayat_pkey primary key (temp_validasi_id)
);

--========================================================================================================================
drop function if exists validasi.validasi_pegawai_gaji_riwayat(numeric, character varying, character varying);
drop type if exists validasi.gaji_riwayat_type;
create type validasi.gaji_riwayat_type as
(
	gaji_riwayat_id integer
	, pegawai_id bigint
	, pejabat_penetap_id integer
	, pangkat_id integer
	, no_sk character varying(100)
	, tanggal_sk date
	, tmt_sk date
	, masa_kerja_tahun integer
	, masa_kerja_bulan integer
	, gaji_pokok integer
	, jenis_kenaikan integer
	, wilayah character varying(100)
	, ktua character varying(100)
	, bulan_dibayar date
	, sudah_dibayar integer
	, potongan_pangkat integer
	, tanggal_update date
	, pejabat_penetap character varying(255)
	, foto_blob text
	, format character varying(255)
	, ukuran numeric
	, user_app_id integer
	, temp_validasi_id integer
	, temp_validasi_hapus_id integer
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
);

drop table if exists validasi.gaji_riwayat;
create table validasi.gaji_riwayat
(
	gaji_riwayat_id integer
	, pegawai_id bigint
	, pejabat_penetap_id integer
	, pangkat_id integer
	, no_sk character varying(100)
	, tanggal_sk date
	, tmt_sk date
	, masa_kerja_tahun integer
	, masa_kerja_bulan integer
	, gaji_pokok integer
	, jenis_kenaikan integer
	, wilayah character varying(100)
	, ktua character varying(100)
	, bulan_dibayar date
	, sudah_dibayar integer
	, potongan_pangkat integer
	, tanggal_update date
	, pejabat_penetap character varying(255)
	, foto_blob text
	, format character varying(255)
	, ukuran numeric
	, user_app_id integer
	, last_create_user character varying(100)
	, last_create_date date
	, last_update_user character varying(100)
	, last_update_date date
	, last_create_satker character varying(25)
	, last_update_satker character varying(25)
	, link_file_apps character varying(255)
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, perubahan_verifikator_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
	, temp_validasi_id integer NOT NULL
	, constraint vgaji_riwayat_pkey primary key (temp_validasi_id)
);

create or replace function validasi.validasi_pegawai_gaji_riwayat(pegawaiid numeric, id character varying, rowid character varying)
returns setof validasi.gaji_riwayat_type as
$body$
declare
	cur refcursor;
	query text;
	rec validasi.gaji_riwayat_type%rowtype;
begin
	if coalesce(nullif(rowid, ''), null) is not null then
		query := '
		select
		a.gaji_riwayat_id, a.pegawai_id, a.pejabat_penetap_id, a.pangkat_id, a.no_sk, a.tanggal_sk, a.tmt_sk
		, a.masa_kerja_tahun, a.masa_kerja_bulan, a.gaji_pokok, a.jenis_kenaikan, a.wilayah, a.ktua, a.bulan_dibayar
		, a.sudah_dibayar, a.potongan_pangkat, a.tanggal_update, a.pejabat_penetap
		, a.foto_blob, a.format, a.ukuran, a.user_app_id
		, a.temp_validasi_id, a.temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
		from
		(
			select
			a.gaji_riwayat_id, a.pegawai_id, a.pejabat_penetap_id, a.pangkat_id, a.no_sk, a.tanggal_sk, a.tmt_sk
			, a.masa_kerja_tahun, a.masa_kerja_bulan, a.gaji_pokok, a.jenis_kenaikan, a.wilayah, a.ktua, a.bulan_dibayar
			, a.sudah_dibayar, a.potongan_pangkat, a.tanggal_update, a.pejabat_penetap
			, a.foto_blob, a.format, a.ukuran, a.user_app_id
			, a.temp_validasi_id, null temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
			from validasi.gaji_riwayat a
			where a.temp_validasi_id = '|| rowid ||'
			and a.pegawai_id = '|| pegawaiid ||'
		) a
		';
	  else
		query := '
		select
		a.gaji_riwayat_id, a.pegawai_id, a.pejabat_penetap_id, a.pangkat_id, a.no_sk, a.tanggal_sk, a.tmt_sk
		, a.masa_kerja_tahun, a.masa_kerja_bulan, a.gaji_pokok, a.jenis_kenaikan, a.wilayah, a.ktua, a.bulan_dibayar
		, a.sudah_dibayar, a.potongan_pangkat, a.tanggal_update, a.pejabat_penetap
		, a.foto_blob, a.format, a.ukuran, a.user_app_id
		, a.temp_validasi_id, a.temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
		from
		(
			select
			a.gaji_riwayat_id, a.pegawai_id
			, coalesce(b.pejabat_penetap_id, coalesce(a.pejabat_penetap_id, a.vpejabat_penetap_id)) pejabat_penetap_id
			, coalesce(b.pangkat_id, a.pangkat_id) pangkat_id
			, coalesce(b.no_sk, a.no_sk) no_sk
			, coalesce(b.tanggal_sk, a.tanggal_sk) tanggal_sk
			, coalesce(b.tmt_sk, a.tmt_sk) tmt_sk
			, coalesce(b.masa_kerja_tahun, a.masa_kerja_tahun) masa_kerja_tahun
			, coalesce(b.masa_kerja_bulan, a.masa_kerja_bulan) masa_kerja_bulan
			, coalesce(b.gaji_pokok, a.gaji_pokok) gaji_pokok
			, coalesce(b.jenis_kenaikan, a.jenis_kenaikan) jenis_kenaikan
			, coalesce(b.wilayah, a.wilayah) wilayah
			, coalesce(b.ktua, a.ktua) ktua
			, coalesce(b.bulan_dibayar, a.bulan_dibayar) bulan_dibayar
			, coalesce(b.sudah_dibayar, a.sudah_dibayar) sudah_dibayar
			, coalesce(b.potongan_pangkat, a.potongan_pangkat) potongan_pangkat
			, coalesce(b.tanggal_update, a.tanggal_update) tanggal_update
			, coalesce(b.pejabat_penetap, a.pejabat_penetap) pejabat_penetap
			, coalesce(b.foto_blob, a.foto_blob) foto_blob
			, coalesce(b.format, a.format) format
			, coalesce(b.ukuran, a.ukuran) ukuran
			, coalesce(b.user_app_id, a.user_app_id) user_app_id
			, b.temp_validasi_id, c.temp_validasi_id temp_validasi_hapus_id, b.validasi, b.validator, b.perubahan_data, b.tipe_perubahan_data, b.tanggal_validasi
			from
			(
				select
				a1.pejabat_penetap_id vpejabat_penetap_id, a.*
				from gaji_riwayat a
				left join pejabat_penetap a1 on a1.jabatan = a.pejabat_penetap
			) a
			left join validasi.gaji_riwayat b on a.gaji_riwayat_id = b.gaji_riwayat_id and b.validasi is null
			left join validasi.hapus_data c on upper(c.hapus_nama)::text = upper(''gaji_riwayat'')::text and a.gaji_riwayat_id = c.temp_validasi_id::numeric and c.validasi is null
			where a.pegawai_id = '|| pegawaiid ||'
			union all
			select
			a.gaji_riwayat_id, a.pegawai_id, a.pejabat_penetap_id, a.pangkat_id, a.no_sk, a.tanggal_sk, a.tmt_sk
			, a.masa_kerja_tahun, a.masa_kerja_bulan, a.gaji_pokok, a.jenis_kenaikan, a.wilayah, a.ktua, a.bulan_dibayar
			, a.sudah_dibayar, a.potongan_pangkat, a.tanggal_update, a.pejabat_penetap
			, a.foto_blob, a.format, a.ukuran, a.user_app_id
			, a.temp_validasi_id, null temp_validasi_hapus_id, a.validasi, a.validator, a.perubahan_data, a.tipe_perubahan_data, a.tanggal_validasi
			from validasi.gaji_riwayat a
			where a.validasi is null and a.gaji_riwayat_id is null
			and a.pegawai_id = '|| pegawaiid ||'
		) a
		where 1=1
		';

		if coalesce(nullif(id, ''), null) is not null then
			query := query || ' and a.gaji_riwayat_id = ' || id;
		end if;
		--raise notice 'sql %', query;
		
	end if;
		
	open cur for execute query;
		fetch cur into rec;
		while found loop
			return next rec;
		fetch cur into rec;
			end loop;
	close cur;
end;
$body$
language plpgsql volatile strict cost 100 rows 1000;
alter function validasi.validasi_pegawai_gaji_riwayat(numeric, character varying, character varying) owner to postgres;

create or replace function validasi.p_gaji_riwayat()
  returns trigger as
$body$
declare

    rec record;
    pinfoperubahan character varying;
    thequery character varying;
    
    begin

	if new.validasi = 1 or new.validasi is null then
		pinfoperubahan := '{ "0" : "0" ';
		if new.gaji_riwayat_id is null then

			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pangkat_id'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_sk'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_sk'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tmt_sk'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_tahun'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_bulan'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gaji_pokok'), ''::character varying, 'valsixdatabaru'::character varying);
			pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_kenaikan'), ''::character varying, 'valsixdatabaru'::character varying);

		else
			for rec in select * from gaji_riwayat a where a.pegawai_id = new.pegawai_id and a.gaji_riwayat_id = new.gaji_riwayat_id
			loop
				if new.validasi is null then
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap_id'), new.pejabat_penetap_id::character varying, rec.pejabat_penetap_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap'), new.pejabat_penetap::character varying, rec.pejabat_penetap::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pangkat_id'), new.pangkat_id::character varying, rec.pangkat_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_sk'), new.no_sk::character varying, rec.no_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_sk'), new.tanggal_sk::character varying, rec.tanggal_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tmt_sk'), new.tmt_sk::character varying, rec.tmt_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_tahun'), new.masa_kerja_tahun::character varying, rec.masa_kerja_tahun::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_bulan'), new.masa_kerja_bulan::character varying, rec.masa_kerja_bulan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gaji_pokok'), new.gaji_pokok::character varying, rec.gaji_pokok::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_kenaikan'), new.jenis_kenaikan::character varying, rec.jenis_kenaikan::character varying);
					
				else
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap_id'), rec.pejabat_penetap_id::character varying, new.pejabat_penetap_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pejabat_penetap'), rec.pejabat_penetap::character varying, new.pejabat_penetap::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('pangkat_id'), rec.pangkat_id::character varying, new.pangkat_id::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('no_sk'), rec.no_sk::character varying, new.no_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tanggal_sk'), rec.tanggal_sk::character varying, new.tanggal_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('tmt_sk'), rec.tmt_sk::character varying, new.tmt_sk::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_tahun'), rec.masa_kerja_tahun::character varying, new.masa_kerja_tahun::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('masa_kerja_bulan'), rec.masa_kerja_bulan::character varying, new.masa_kerja_bulan::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('gaji_pokok'), rec.gaji_pokok::character varying, new.gaji_pokok::character varying);
					pinfoperubahan:= validasi.collectinfo(pinfoperubahan, upper('jenis_kenaikan'), rec.jenis_kenaikan::character varying, new.jenis_kenaikan::character varying);

				end if;
				
			end loop;
		end if;
		
		pinfoperubahan:= pinfoperubahan || ' }';
		--raise notice 'sql %', pinfoperubahan;
	end if;
	
	if new.validasi = 1 then 
		if new.gaji_riwayat_id is null then
			if new.tanggal_validasi is null then
				new.perubahan_verifikator_data= pinfoperubahan;
			else
				insert into gaji_riwayat 
				(
					gaji_riwayat_id, pegawai_id, pejabat_penetap_id, pejabat_penetap, pangkat_id, no_sk, tanggal_sk, tmt_sk
					, masa_kerja_tahun, masa_kerja_bulan, gaji_pokok, jenis_kenaikan
					, last_create_user, last_create_date, last_create_satker
					, last_update_user, last_update_date, last_update_satker
				)
				values 
				(
					(select coalesce(max(gaji_riwayat_id), 0) + 1 from gaji_riwayat), new.pegawai_id
					, new.pejabat_penetap_id, new.pejabat_penetap, new.pangkat_id, new.no_sk, new.tanggal_sk, new.tmt_sk
					, new.masa_kerja_tahun, new.masa_kerja_bulan, new.gaji_pokok, new.jenis_kenaikan
					, new.last_create_user, new.last_create_date, new.last_create_satker
					, new.last_update_user, new.last_update_date, new.last_update_satker
				);
				--raise notice 'sql %', '';
			end if;
		else
			if new.tanggal_validasi is null then
				new.perubahan_verifikator_data= pinfoperubahan;
			else
				select validasi.vupdateinfo('gaji_riwayat', new.gaji_riwayat_id, new.temp_validasi_id, new.last_update_user, 99) into thequery;

				if thequery is not null then
					--new.last_level:= old.last_level;
					execute thequery;
				end if;
			end if;
			--raise notice 'sql %', thequery;
			--return null;
		end if;
	elsif new.validasi = 2 then 
		--raise notice 'sql %', '';
	else
		new.perubahan_data := pinfoperubahan;
	end if;

	return new;
    end;
$body$
language plpgsql volatile cost 100;
alter function validasi.p_gaji_riwayat() owner to postgres;

drop trigger if exists t_gaji_riwayat on validasi.gaji_riwayat;
create trigger t_gaji_riwayat
before insert or update
on validasi.gaji_riwayat
for each row
execute procedure validasi.p_gaji_riwayat();

--========================================================================================================================
drop table if exists validasi.pak;
create table validasi.pak
(
	pak_id bigint
	, pegawai_id bigint
	, format character varying(255)
	, ukuran numeric
	, user_app_id integer
	, nomor_surat character varying(255)
	, tahun numeric
	, nomor_sk character varying(255)
	, tgl_sk date
	, angka_kredit character varying(50)
	, bulan_mulai character varying(5)
	, tahun_mulai numeric
	, bulan_selesai character varying(5)
	, tahun_selesai numeric
	, last_create_user character varying(100)
	, last_create_date date
	, last_update_user character varying(100)
	, last_update_date date
	, last_create_satker character varying(25)
	, last_update_satker character varying(25)
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, perubahan_verifikator_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
	, temp_validasi_id integer NOT NULL
	, constraint vpak_pkey primary key (temp_validasi_id)
);

--========================================================================================================================
drop table if exists validasi.skp;
create table validasi.skp
(
	skp_id integer
	, pegawai_id bigint
	, pejabat_id bigint
	, atasan_pejabat_id bigint
	, tahun integer
	, nilai numeric
	, orientasi_pelayanan character varying(255)
	, integritas character varying(255)
	, komitmen character varying(255)
	, disiplin character varying(255)
	, kerjasama character varying(255)
	, kepemimpinan character varying(255)
	, format character varying(255)
	, ukuran numeric
	, user_app_id bigint
	, inisiatif_kerja character varying(255)
	, last_create_user character varying(100)
	, last_create_date date
	, last_update_user character varying(100)
	, last_update_date date
	, last_create_satker character varying(25)
	, last_update_satker character varying(25)
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, perubahan_verifikator_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
	, temp_validasi_id integer NOT NULL
	, constraint vskp_pkey primary key (temp_validasi_id)
);

--========================================================================================================================
drop table if exists validasi.kinerja;
create table validasi.kinerja
(
	kinerja_id integer not null
	, pegawai_id bigint
	, user_app_id integer
	, tahun numeric
	, hasil_kerja character varying(255)
	, perilaku_kerja character varying(255)
	, predikat_kinerja character varying(255)
	, nip_pejabat_penilai character varying(100)
	, nama_pejabat_penilai character varying(255)
	, last_create_user character varying(100)
	, last_create_date date
	, last_update_user character varying(100)
	, last_update_date date
	, last_create_satker character varying(25)
	, last_update_satker character varying(25)
	, validasi integer
	, validator character varying
	, perubahan_data character varying
	, perubahan_verifikator_data character varying
	, tipe_perubahan_data character(1)
	, tanggal_validasi timestamp without time zone
	, temp_validasi_id integer NOT NULL
	, constraint vkinerja_pkey primary key (temp_validasi_id)
);

---============================================ untuk data validasi ini pastikan terakhir
drop type if exists validasi.perubahandatavalidasi_type;
create type validasi.perubahandatavalidasi_type as
(
	temp_validasi_id integer
	, row_id numeric
	, row_hapus_id numeric
	, info_link character varying
	, info_table character varying
	, pegawai_id numeric
	, info_riwayat character varying
	, info_jenis character varying
	, info_keterangan character varying
	, info_tanggal date
	, info_jenis_update character varying
	, info_status character varying
	, info_level numeric
	, info_level_nama character varying
	, info_validasi numeric
	, info_create_date timestamp without time zone
);

create or replace function validasi.validasi_perubahandatavalidasi(vpid character varying)
  returns setof validasi.perubahandatavalidasi_type as
$body$
declare
	cur refcursor;
	query text;
	rec validasi.perubahandatavalidasi_type%rowtype;
begin
	query:= '
		select
			temp_validasi_id, row_id, row_hapus_id, info_link, info_table, pegawai_id
			, validasi.tipejenisinfo(''riwayat'', info_riwayat::character varying) info_riwayat
			, info_jenis, info_keterangan, info_tanggal
			,
			case
			when row_hapus_id is null then
				validasi.tipejenisinfo(''jenis'', row_id::character varying)
			else
				validasi.tipejenisinfo(''jenis'', ''xxx''::character varying)
			end info_jenis_update
			, validasi.tipejenisinfo(''status'', validasi::character varying) info_status
			, info_level, validasi.tipejenisinfo(''hak'', info_level::character varying) info_level_nama
			, info_validasi, info_create_date
		from
		(
			select
			temp_validasi_id, pangkat_riwayat_id row_id, null::numeric row_hapus_id, ''riwayat_pangkat_add'' info_link, ''pangkat_riwayat'' info_table, pegawai_id
			, ''FIP - 02. Riwayat Pangkat'' info_riwayat, ''Reguler'' info_jenis,  no_sk info_keterangan
			, tmt_pangkat info_tanggal, validasi, 30 info_level
			, validasi info_validasi
			, last_create_date info_create_date
			from validasi.pangkat_riwayat where 1=1
			union all
			select
			temp_validasi_id, pangkat_riwayat_id row_id, c.temp_validasi_id row_hapus_id, ''riwayat_pangkat_add'' info_link, ''pangkat_riwayat'' info_table, a.pegawai_id
			, ''FIP - 02. Riwayat Pangkat'' info_riwayat, ''Reguler'' info_jenis, no_sk info_keterangan
			, tmt_pangkat info_tanggal, validasi, 30 info_level
			, validasi info_validasi
			, A.last_create_date info_create_date
			from pangkat_riwayat a
			inner join validasi.hapus_data c on upper(c.hapus_nama::text) = upper(''pangkat_riwayat''::text) and a.pangkat_riwayat_id = c.temp_validasi_id::numeric AND c.validasi is null
			where 1=1
			union all
			select
			temp_validasi_id, row_id, row_hapus_id, info_link, info_table, pegawai_id
			, info_riwayat, info_jenis, info_keterangan
			, info_tanggal, validasi, 30 info_level
			, validasi info_validasi
			, info_create_date
			from
			(
				select
				case lower(info_status) when lower(''batal'') then 2 when lower(''hapus'') then 1 end validasi
				, a.*
				from validasi.hapus_log a
			) a
			where upper(a.info_table::text) = upper(''pangkat_riwayat''::text)
			union all
			select
			temp_validasi_id, gaji_riwayat_id row_id, null::numeric row_hapus_id, ''riwayat_gaji_add'' info_link, ''gaji_riwayat'' info_table, pegawai_id
			, ''FIP - 02. Riwayat Gaji'' info_riwayat, ''Reguler'' info_jenis,  no_sk info_keterangan
			, tmt_sk info_tanggal, validasi, 30 info_level
			, validasi info_validasi
			, last_create_date info_create_date
			from validasi.gaji_riwayat where 1=1
			union all
			select
			temp_validasi_id, gaji_riwayat_id row_id, c.temp_validasi_id row_hapus_id, ''riwayat_gaji_add'' info_link, ''gaji_riwayat'' info_table, a.pegawai_id
			, ''FIP - 02. Riwayat Gaji'' info_riwayat, ''Reguler'' info_jenis, no_sk info_keterangan
			, tmt_sk info_tanggal, validasi, 30 info_level
			, validasi info_validasi
			, A.last_create_date info_create_date
			from gaji_riwayat a
			inner join validasi.hapus_data c on upper(c.hapus_nama::text) = upper(''gaji_riwayat''::text) and a.gaji_riwayat_id = c.temp_validasi_id::numeric AND c.validasi is null
			where 1=1
			union all
			select
			temp_validasi_id, row_id, row_hapus_id, info_link, info_table, pegawai_id
			, info_riwayat, info_jenis, info_keterangan
			, info_tanggal, validasi, 30 info_level
			, validasi info_validasi
			, info_create_date
			from
			(
				select
				case lower(info_status) when lower(''batal'') then 2 when lower(''hapus'') then 1 end validasi
				, a.*
				from validasi.hapus_log a
			) a
			where upper(a.info_table::text) = upper(''gaji_riwayat''::text)
		) a
		where 1=1
	';

	if coalesce(nullif(vpid, ''), null) is not null then
		query:= query || ' and a.pegawai_id = ' || vpid;
	end if;
	--raise notice 'sql %', query;
	
	open cur for execute query;
		fetch cur into rec;
		while found loop
			return next rec;
			fetch cur into rec;
		end loop;
	close cur;
end;
$body$
language plpgsql volatile strict
cost 100
rows 1000;
alter function validasi.validasi_perubahandatavalidasi(character varying) owner to postgres;